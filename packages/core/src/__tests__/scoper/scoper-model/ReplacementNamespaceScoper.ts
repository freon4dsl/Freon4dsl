// Generated by the Freon Language Generator.
import { FreNamespace, FreNamespaceInfo, FreScoperBase } from '../../../scoper';
import { FreNamedNode, FreNode, FreNodeReference } from '../../../ast';
import { UnitA } from './UnitA';
import { ScoperModel } from './ScoperModel';
import { UnitB } from './UnitB';
import { NodeX } from './NodeX';
import { AST } from '../../../change-manager';
import { IWithName } from './IWithName';
import { NodeY } from './NodeY';

/**
 * Class ReplacementNamespaceScoper implements the scoper generated from, if present, the scoper definition,
 * otherwise this class implements the default scoper.
 */
export class ReplacementNamespaceScoper extends FreScoperBase {
    useUnitA: boolean = false;
    useUnitB: boolean = false;
    useNodeX: boolean = false;
    useNodeY: boolean = false;
    useReference: boolean = false;

    /**
     * Returns the replacement namespace if it can be found for 'node'.
     * @param node
     */
    public alternativeNamespaces(node: FreNode): FreNamespaceInfo[] {
        let result: FreNamespaceInfo[] = [];
        // namespace addition for UnitA
        if (node instanceof UnitA) {
            if (this.useUnitB) {
                // owner().if(ScoperModel).B_units
                for (let u of (node.freOwner() as ScoperModel)?.B_units) {
                    result.push(new FreNamespaceInfo(u, false));
                }
            } else if (this.useNodeX) {
                // owner().if(ScoperModel).B_units.childrenWithName
                for (let u of (node.freOwner() as ScoperModel)?.B_units.map(u => u.childrenWithName).flat(1)) {
                    result.push(new FreNamespaceInfo(u, false));
                }
            }
        } else if (node instanceof UnitB) {
            if (this.useUnitA) {
                // owner().if(ScoperModel).A_units
                for (let u of (node.freOwner() as ScoperModel)?.A_units) {
                    result.push(new FreNamespaceInfo(u, false));
                }
            } else if (this.useNodeY) {
                // owner().if(ScoperModel).A_units.childrenWithName
                for (let u of (node.freOwner() as ScoperModel)?.A_units.map(u => u.childrenWithName).flat(1)) {
                    result.push(new FreNamespaceInfo(u, false));
                }
            }
        } else if (node instanceof NodeY) {
            if (this.useReference) {
                AST.change ( () => {
                    // we create a reference in the parent node, which can then be used as replacement namespace
                    const newRef = FreNodeReference.create<NodeX>('B_2', 'NodeX');
                    (node.freOwner() as IWithName).myRef.push(newRef);
                    (node.freOwner() as IWithName).myRef.forEach( ref => {
                        result.push(new FreNamespaceInfo(ref, false));
                    })
                })
            }
        }
        return result;
    }

    /**
     * Returns all FreNodes that are defined as additional namespaces for 'node'.
     * @param node
     */
    public importedNamespaces(node: FreNode): FreNamespaceInfo[] {
        return [];
    }
}
